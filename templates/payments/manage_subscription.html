{% extends 'base.html' %}

{% block title %}Manage Subscription - EyeHealth 20-20-20{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-cog me-2"></i>Manage Subscription</h2>
                <div>
                    {% if payment_method %}
                    <span class="badge bg-info me-2">{{ payment_method }}</span>
                    {% endif %}
                    <span class="badge bg-{{ subscription.status == 'active' and 'success' or 'secondary' }} fs-6">
                        {{ subscription.get_status_display|upper }}
                    </span>
                </div>
            </div>
            
            <!-- Subscription Overview -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Subscription Details</h5>
                    <div>
                        {% if payment_method == 'PayPal' %}
                        <i class="fab fa-paypal text-primary me-2"></i>
                        {% elif payment_method == 'Stripe' %}
                        <i class="fab fa-stripe text-info me-2"></i>
                        {% endif %}
                        <i class="fas fa-crown text-warning"></i>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Plan:</strong> Premium</p>
                            <p><strong>Amount:</strong> ${{ subscription.amount }}/month</p>
                            <p><strong>Payment Method:</strong> {{ payment_method|default:"Unknown" }}</p>
                            <p><strong>Status:</strong> 
                                <span class="badge bg-{{ subscription.status == 'active' and 'success' or 'secondary' }}">
                                    {{ subscription.get_status_display }}
                                </span>
                            </p>
                        </div>
                        <div class="col-md-6">
                            {% if subscription.activated_at %}
                            <p><strong>Started:</strong> {{ subscription.activated_at|date:"M d, Y" }}</p>
                            {% endif %}
                            {% if subscription.last_payment_date %}
                            <p><strong>Last Payment:</strong> {{ subscription.last_payment_date|date:"M d, Y" }}</p>
                            {% endif %}
                            {% if subscription.next_payment_date %}
                            <p><strong>Next Payment:</strong> {{ subscription.next_payment_date|date:"M d, Y" }}</p>
                            {% endif %}
                        </div>
                    </div>
                    
                    {% if subscription.card_last4 %}
                    <div class="mt-3 p-3 bg-light rounded">
                        <h6><i class="fas fa-credit-card me-2"></i>Payment Method</h6>
                        <p class="mb-0">
                            <i class="fab fa-cc-{{ subscription.card_brand|lower }} me-2"></i>
                            •••• •••• •••• {{ subscription.card_last4 }}
                            {% if subscription.card_exp_month and subscription.card_exp_year %}
                                ({{ subscription.card_exp_month }}/{{ subscription.card_exp_year }})
                            {% endif %}
                        </p>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Actions -->
            {% if subscription.status == 'active' %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Subscription Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6>Cancel Subscription</h6>
                            <p class="text-muted mb-0">Choose how you'd like to cancel your Premium subscription.</p>
                        </div>
                        <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#cancelModal">
                            <i class="fas fa-times me-2"></i>Cancel
                        </button>
                    </div>
                </div>
            </div>
            {% elif subscription.status == 'cancelled' %}
            <div class="card mb-4 border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-pause-circle me-2"></i>Subscription Cancelled</h5>
                </div>
                <div class="card-body">
                    {% if subscription.cancelled_at %}
                    <p class="mb-3">Your subscription was cancelled on {{ subscription.cancelled_at|date:"M d, Y" }}.</p>
                    {% endif %}
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Want to come back?</strong> You can reactivate your Premium subscription anytime.
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6>Reactivate Premium Subscription</h6>
                            <p class="text-muted mb-0">Restore your Premium features and resume billing.</p>
                        </div>
                        <form method="post" action="{% url 'payments:reactivate_subscription' %}" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-play me-2"></i>Reactivate
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Payment History -->
            {% if recent_payments %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Recent Payments</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Date</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Payment Method</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for payment in recent_payments %}
                                <tr>
                                    <td>{{ payment.payment_date|date:"M d, Y" }}</td>
                                    <td>${{ payment.amount }}</td>
                                    <td>
                                        <span class="badge bg-{{ payment.payment_status == 'completed' and 'success' or 'warning' }}">
                                            {{ payment.get_payment_status_display }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if payment_method == 'Stripe' %}
                                            {% if payment.card_last4 %}
                                                <i class="fab fa-cc-{{ payment.card_brand|lower }} me-1"></i>
                                                •••• {{ payment.card_last4 }}
                                            {% else %}
                                                <i class="fab fa-stripe me-1"></i>Card
                                            {% endif %}
                                        {% elif payment_method == 'PayPal' %}
                                            <i class="fab fa-paypal me-1"></i>PayPal
                                        {% else %}
                                            {{ payment_method|default:"Payment" }}
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Premium Features Reminder -->
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-star me-2"></i>Your Premium Features</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <ul class="list-unstyled">
                                <li><i class="fas fa-check text-success me-2"></i>Unlimited sessions</li>
                                <li><i class="fas fa-check text-success me-2"></i>Smart timer customization</li>
                                <li><i class="fas fa-check text-success me-2"></i>Advanced analytics</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <ul class="list-unstyled">
                                <li><i class="fas fa-check text-success me-2"></i>Guided eye exercises</li>
                                <li><i class="fas fa-check text-success me-2"></i>Custom themes</li>
                                <li><i class="fas fa-check text-success me-2"></i>Priority support</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="text-center mt-4">
                <a href="{% url 'timer:dashboard' %}" class="btn btn-primary">
                    <i class="fas fa-tachometer-alt me-2"></i>Back to Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Cancel Confirmation Modal -->
<div class="modal fade" id="cancelModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cancel Subscription</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong>How would you like to cancel your Premium subscription?</strong></p>
                
                <!-- Cancellation Options -->
                <div class="row g-3">
                    <!-- Cancel at Period End -->
                    <div class="col-12">
                        <div class="card border-warning">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-calendar-check text-warning me-2"></i>
                                    Cancel at End of Billing Period (Recommended)
                                </h6>
                                <p class="card-text small text-muted mb-3">
                                    Keep your Premium access until {% if subscription.next_payment_date %}{{ subscription.next_payment_date|date:"M d, Y" }}{% else %}the end of your current billing period{% endif %}, then automatically switch to Free.
                                </p>
                                <ul class="small mb-3">
                                    <li>✅ Keep Premium features until period ends</li>
                                    <li>✅ No immediate loss of access</li>
                                    <li>✅ No refund needed</li>
                                    <li>✅ Can resubscribe anytime</li>
                                </ul>
                                <form method="post" action="{% url 'payments:cancel_subscription' %}" class="d-inline">
                                    {% csrf_token %}
                                    <input type="hidden" name="cancel_type" value="at_period_end">
                                    <button type="submit" class="btn btn-warning">
                                        <i class="fas fa-calendar-times me-2"></i>Cancel at Period End
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Cancel Immediately -->
                    <div class="col-12">
                        <div class="card border-danger">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-stop-circle text-danger me-2"></i>
                                    Cancel Immediately
                                </h6>
                                <p class="card-text small text-muted mb-3">
                                    Immediately lose Premium access and switch to Free plan right now.
                                </p>
                                <ul class="small mb-3">
                                    <li>⚠️ Immediate loss of Premium features</li>
                                    <li>⚠️ No refund for current period</li>
                                    <li>✅ Can resubscribe anytime</li>
                                </ul>
                                <form method="post" action="{% url 'payments:cancel_subscription' %}" class="d-inline">
                                    {% csrf_token %}
                                    <input type="hidden" name="cancel_type" value="immediately">
                                    <button type="submit" class="btn btn-outline-danger">
                                        <i class="fas fa-times me-2"></i>Cancel Immediately
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle me-2"></i>
                    <small>
                        <strong>Need help?</strong> Contact our support team if you're experiencing issues with the service instead of cancelling.
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-arrow-left me-2"></i>Keep My Subscription
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .badge {
        font-size: 0.8rem;
    }
    
    .table td {
        vertical-align: middle;
    }
    
    .card {
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}