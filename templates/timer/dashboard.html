{% extends 'base.html' %}
{% load timezone_tags %}

{% block title %}Dashboard - EyeHealth 20-20-20{% endblock %}

{% block extra_css %}
<style>
    .timer-container {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        border-radius: 1rem;
        color: white;
        padding: 2rem;
        margin-bottom: 2rem;
    }

    .dashboard-timer-circle {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 3px solid rgba(255, 255, 255, 0.2);
    }
    
    .session-card {
        transition: transform 0.2s ease-in-out;
    }
    
    .session-card:hover {
        transform: translateY(-2px);
    }
    
    .progress-ring {
        transform: rotate(-90deg);
    }
    
    .progress-ring-circle {
        transition: stroke-dasharray 0.3s ease-in-out;
        fill: transparent;
        stroke: #ffc107;
        stroke-width: 4;
        stroke-linecap: round;
    }
    
    /* Emergency fixes for modal issues */
    .modal.show {
        display: block !important;
    }
    
    .modal-backdrop {
        z-index: 1040;
    }
    
    .modal {
        z-index: 1050;
    }
    
    /* Force close button styling */
    .btn-outline-danger.btn-sm {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        margin-left: auto;
    }
    
    /* Notification improvements */
    .notification {
        z-index: 10000 !important;
    }
    
    /* Sound notification animations */
    .sound-notification {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    @keyframes soundPulse {
        0% { 
            transform: translateX(-50%) scale(0.8);
            opacity: 0;
        }
        10% {
            transform: translateX(-50%) scale(1.1);
            opacity: 1;
        }
        20% {
            transform: translateX(-50%) scale(0.95);
        }
        30% {
            transform: translateX(-50%) scale(1.05);
        }
        40% {
            transform: translateX(-50%) scale(0.98);
        }
        100% {
            transform: translateX(-50%) scale(1);
            opacity: 1;
        }
    }
    
    @keyframes fadeOut {
        from {
            opacity: 1;
            transform: translateX(-50%) scale(1);
        }
        to {
            opacity: 0;
            transform: translateX(-50%) scale(0.8);
        }
    }

    @keyframes pulse {
        0%, 100% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(13, 110, 253, 0.7);
        }
        50% {
            transform: scale(1.05);
            box-shadow: 0 0 20px 10px rgba(13, 110, 253, 0);
        }
    }

    .pulse-animation {
        animation: pulse 2s infinite;
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container mt-4">
    <!-- Welcome Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h2 mb-1">Welcome back, {{ user.first_name|default:user.username }}!</h1>
                    <p class="text-muted mb-0">
                        <i class="fas fa-calendar-day me-1"></i>
                        Today is {% now "l, F j, Y" %}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Timer Section -->
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="timer-container text-center">
                {% if active_session %}
                    <h3 class="mb-3">
                        <i class="fas fa-play-circle me-2"></i>Timer Active
                        <span class="badge bg-success ms-2">{{ intervals_today }} intervals today</span>
                    </h3>
                {% else %}
                    <h3 class="mb-3">
                        <i class="fas fa-pause-circle me-2"></i>Ready to Start
                        <span class="badge bg-info ms-2">{{ intervals_today }} intervals used</span>
                    </h3>
                {% endif %}
                
                <div class="timer-circle dashboard-timer-circle d-flex flex-column justify-content-center align-items-center">
                    <svg class="progress-ring" width="100%" height="100%">
                        <circle class="progress-ring-circle" 
                                cx="50%" cy="50%" r="110" 
                                stroke-dasharray="0 691.15" id="progress-circle"></circle>
                    </svg>
                    <div class="position-absolute">
                        <div class="timer-display" id="timer-display">
                            {% if active_session %}20:00{% else %}Ready{% endif %}
                        </div>
                        <div class="mt-2">
                            <small>{% if active_session %}Next Break In{% else %}Click Start{% endif %}</small>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4">
                    {% if active_session %}
                        <button class="btn btn-danger btn-lg me-3" id="end-session-btn">
                            <i class="fas fa-stop me-2"></i>Stop Timer
                        </button>
                        <button class="btn btn-outline-light btn-lg" id="take-break-btn">
                            <i class="fas fa-coffee me-2"></i>Take Break Now
                        </button>
                    {% else %}
                        {% if can_start_session %}
                            <button class="btn btn-success btn-lg" id="start-session-btn">
                                <i class="fas fa-play me-2"></i>Start 20-20-20 Timer
                            </button>
                        {% else %}
                            <div class="alert alert-warning mt-3">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                You've reached your daily limit. Come back tomorrow to continue!
                            </div>
                        {% endif %}
                    {% endif %}
                </div>
                
                {% if active_session %}
                    <div class="mt-3">
                        <small class="text-white-50">
                            Started: <span id="session-start-time">{{ active_session.start_time|user_timezone:user|time:"g:i A" }}</span> |
                            Breaks taken: {{ active_session.total_breaks_taken }}
                        </small>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Today's Statistics -->
    <div class="row mb-4">
        <div class="col-12">
            <h4 class="mb-3">
                <i class="fas fa-chart-line me-2"></i>Today's Progress
            </h4>
        </div>
        <div class="col-lg-4 col-md-6 mb-3">
            <div class="card session-card h-100">
                <div class="card-body text-center">
                    <div class="text-success mb-2">
                        <i class="fas fa-tasks fa-2x"></i>
                    </div>
                    <h3 class="mb-1">{{ intervals_today }}</h3>
                    <p class="text-muted mb-0">Intervals Used Today</p>
                </div>
            </div>
        </div>
        <div class="col-lg-4 col-md-6 mb-3">
            <div class="card session-card h-100">
                <div class="card-body text-center">
                    <div class="text-warning mb-2">
                        <i class="fas fa-coffee fa-2x"></i>
                    </div>
                    <h3 class="mb-1">{{ today_stats.total_breaks_taken|default:0 }}</h3>
                    <p class="text-muted mb-0">Breaks Taken</p>
                </div>
            </div>
        </div>
        <div class="col-lg-4 col-md-6 mb-3">
            <div class="card session-card h-100">
                <div class="card-body text-center">
                    <div class="text-info mb-2">
                        <i class="fas fa-percentage fa-2x"></i>
                    </div>
                    <h3 class="mb-1">{{ today_stats.compliance_rate|floatformat:0|default:0 }}%</h3>
                    <p class="text-muted mb-0">Compliance Rate</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Sponsored Content (AdSense Placeholder) -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 bg-light">
                <div class="card-body text-center py-3">
                    <small class="text-muted">Sponsored Â· Supports Free Eye Health Tools</small>
                    <div id="adsense-banner" class="my-2">
                        <!-- Google AdSense code will go here -->
                        <!-- Replace this div with your AdSense code -->
                        <div style="min-height: 90px; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border: 1px dashed #dee2e6; border-radius: 8px;">
                            <p class="text-muted mb-0"><small>ðŸŽ¯ Ad Space - Keep this app free!</small></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- How It Works Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>How the 20-20-20 Rule Works
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="d-flex align-items-start">
                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                    <span class="fw-bold">20</span>
                                </div>
                                <div>
                                    <h6 class="mb-1">Every 20 Minutes</h6>
                                    <small class="text-muted">Work in focused 20-minute intervals. The timer will automatically remind you when it's time for a break.</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="d-flex align-items-start">
                                <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                    <span class="fw-bold">20</span>
                                </div>
                                <div>
                                    <h6 class="mb-1">Look 20 Feet Away</h6>
                                    <small class="text-muted">During breaks, look at something at least 20 feet away to relax your eye muscles and reduce strain.</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="d-flex align-items-start">
                                <div class="bg-warning text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                    <span class="fw-bold">20</span>
                                </div>
                                <div>
                                    <h6 class="mb-1">For 20 Seconds</h6>
                                    <small class="text-muted">Hold your gaze on the distant object for at least 20 seconds. This gives your eyes time to reset and refocus.</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-tasks me-2 text-primary"></i>Intervals Explained</h6>
                            <p class="small text-muted mb-0">Each work session consists of multiple 20-minute intervals. Complete intervals help track your productivity and compliance with the 20-20-20 rule.</p>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-coffee me-2 text-success"></i>Break Benefits</h6>
                            <p class="small text-muted mb-0">Regular breaks prevent digital eye strain, reduce fatigue, and improve focus. Compliant breaks (looking at distance) are most effective.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recommended Eye Health Products (Affiliate) -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-glasses me-2"></i>Protect Your Eyes
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">Recommended products to complement the 20-20-20 rule:</p>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="text-center">
                                <i class="fas fa-glasses fa-3x text-primary mb-2"></i>
                                <h6>Blue Light Glasses</h6>
                                <p class="small text-muted">Filter harmful blue light from screens</p>
                                <a href="#" class="btn btn-sm btn-outline-primary" target="_blank" rel="noopener">
                                    View on Amazon <i class="fas fa-external-link-alt ms-1"></i>
                                </a>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="text-center">
                                <i class="fas fa-eye-dropper fa-3x text-info mb-2"></i>
                                <h6>Lubricating Eye Drops</h6>
                                <p class="small text-muted">Relieve dry eyes from screen time</p>
                                <a href="#" class="btn btn-sm btn-outline-info" target="_blank" rel="noopener">
                                    View on Amazon <i class="fas fa-external-link-alt ms-1"></i>
                                </a>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="text-center">
                                <i class="fas fa-laptop fa-3x text-success mb-2"></i>
                                <h6>Monitor Light Bar</h6>
                                <p class="small text-muted">Reduce screen glare & eye strain</p>
                                <a href="#" class="btn btn-sm btn-outline-success" target="_blank" rel="noopener">
                                    View on Amazon <i class="fas fa-external-link-alt ms-1"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="text-center mt-2">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            These are affiliate links. Purchases help keep this app free!
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>Recent Activity
                    </h5>
                    <a href="{% url 'timer:statistics' %}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-chart-bar me-1"></i>View All Statistics
                    </a>
                </div>
                <div class="card-body">
                    {% if recent_sessions %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Time</th>
                                        <th>Intervals</th>
                                        <th>Breaks</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for session in recent_sessions %}
                                    <tr>
                                        <td>{{ session.start_time|user_timezone:user|date:"M j" }}</td>
                                        <td>{{ session.start_time|user_timezone:user|time:"g:i A" }}</td>
                                        <td>
                                            <span class="badge bg-primary">{{ session.total_intervals_completed }} interval{{ session.total_intervals_completed|pluralize }}</span>
                                        </td>
                                        <td>
                                            <span class="badge bg-success">{{ session.total_breaks_taken }} break{{ session.total_breaks_taken|pluralize }}</span>
                                        </td>
                                        <td>
                                            {% if session.is_active %}
                                                <span class="badge bg-warning">Active</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Completed</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-clock fa-3x text-muted mb-3"></i>
                            <h5>No activity yet</h5>
                            <p class="text-muted">Start your first 20-20-20 timer to begin tracking your eye health progress.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Break Reminder Modal -->
<div class="modal fade" id="breakModal" tabindex="-1" aria-labelledby="breakModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="breakModalLabel">
                    <i class="fas fa-eye me-2"></i>Time for a Break!
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-4">
                    <i class="fas fa-eye fa-4x text-warning mb-3"></i>
                    <h4>Follow the 20-20-20 Rule</h4>
                    <p class="lead">Look at something <strong>20 feet away</strong> for <strong>20 seconds</strong></p>
                </div>
                
                <div class="break-timer mb-4">
                    <div class="display-4 text-primary" id="break-countdown">20</div>
                    <p id="countdown-status">seconds remaining</p>
                </div>
                
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="looked-distance">
                    <label class="form-check-label" for="looked-distance">
                        I looked at something 20 feet away
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="skip-break-btn">
                    <i class="fas fa-forward me-2"></i>Skip Break
                </button>
                <button type="button" class="btn btn-success" id="complete-break-btn">
                    <i class="fas fa-check me-2"></i>Break Complete
                </button>
                <button type="button" class="btn btn-outline-danger btn-sm" id="force-close-modal-btn" title="Close if modal is stuck">
                    <i class="fas fa-times me-1"></i>Force Close
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script nonce="{{ request.csp_nonce }}">
    // Utility function to get CSRF token from cookie or DOM
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function getCSRFToken() {
        // Try to get from cookie first
        let token = getCookie('csrftoken');

        // Fallback: get from DOM element
        if (!token) {
            const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
            if (csrfInput) {
                token = csrfInput.value;
            }
        }

        // Fallback: get from meta tag
        if (!token) {
            const csrfMeta = document.querySelector('meta[name="csrf-token"]');
            if (csrfMeta) {
                token = csrfMeta.getAttribute('content');
            }
        }

        console.log('ðŸ” CSRF Token retrieved:', token ? 'Found' : 'Not found');
        return token;
    }

    let timerInterval;
    let currentSession = {% if active_session %}{{ active_session.id }}{% else %}null{% endif %};
    let currentInterval = {% if active_interval %}{{ active_interval.id }}{% else %}null{% endif %};
    let currentBreak = null;
    let timeRemaining = 1200; // 20 minutes in seconds
    let breakModalTimeout = null;
    let modalAutoCloseTimeout = null;
    let isModalStuck = false;

    function startSession() {
        console.log('ðŸš€ Starting timer session...');

        // Get CSRF token using enhanced function
        const csrfToken = getCSRFToken();

        if (!csrfToken) {
            console.error('âŒ CSRF token not found');
            alert('Security token missing. Please refresh the page and try again.');
            return;
        }

        const url = '{% url "timer:start_session" %}';
        console.log('ðŸ“¡ Sending request to:', url);

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json',
            },
        })
        .then(response => {
            console.log('ðŸ“¥ Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('ðŸ“¦ Response data:', data);
            if (data.success) {
                console.log('âœ… Session started successfully');
                currentSession = data.session_id;
                currentInterval = data.interval_id;
                startTimer();
                location.reload();
            } else {
                console.error('âŒ Server returned error:', data.message);
                alert(data.message || 'Failed to start session');
            }
        })
        .catch(error => {
            console.error('âŒ Error starting session:', error);
            alert('Failed to start session. Please check the console for details.');
        });
    }

    function endSession() {
        if (!currentSession) return;

        const csrfToken = getCSRFToken();

        fetch('{% url "timer:end_session" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                stopTimer();
                location.reload();
            } else {
                alert(data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }

    function takeBreak() {
        if (!currentSession || !currentInterval) return;

        const csrfToken = getCSRFToken();

        fetch('{% url "timer:take_break" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                session_id: currentSession,
                interval_id: currentInterval,
                looked_at_distance: false
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentBreak = data.break_id;
                showBreakModal();
            } else {
                alert(data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }

    function completeBreak() {
        if (!currentBreak) {
            console.warn('No current break to complete, closing modal');
            hideBreakModal();
            return;
        }
        
        const lookedAtDistance = document.getElementById('looked-distance')?.checked || false;

        const csrfToken = getCSRFToken();

        // Add timeout to prevent hanging
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 second timeout

        fetch('{% url "timer:complete_break" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                break_id: currentBreak,
                looked_at_distance: lookedAtDistance
            }),
            signal: controller.signal
        })
        .then(response => {
            clearTimeout(timeoutId);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                console.log('âœ… Break completed successfully');
                currentBreak = null;
                currentInterval = data.next_interval_id;

                // Hide modal first
                hideBreakModal();

                // Wait for modal to fully hide before starting timer
                setTimeout(() => {
                    if (currentInterval) {
                        console.log('â–¶ï¸ Starting next interval...');
                        resetTimer();
                    }
                }, 500);

            } else {
                console.error('âŒ Break completion failed:', data.message);
                showNotification('Break completion failed: ' + (data.message || 'Unknown error'), 'error');
                // Still close modal to prevent getting stuck
                hideBreakModal();
            }
        })
        .catch(error => {
            clearTimeout(timeoutId);
            console.error('Error completing break:', error);
            
            if (error.name === 'AbortError') {
                showNotification('Break completion timed out. Closing modal...', 'warning');
            } else {
                showNotification('Network error completing break. Closing modal...', 'error');
            }
            
            // Always close modal to prevent getting stuck
            currentBreak = null;
            hideBreakModal();
            
            // Resume timer
            if (currentSession) {
                resetTimer();
            }
        });
    }

    function skipBreak() {
        try {
            // Clear current break if exists
            currentBreak = null;
            
            hideBreakModal();
            showNotification('Break skipped. Remember that regular breaks help protect your vision!', 'warning');
            
            // Resume timer if session is active
            if (currentSession) {
                resetTimer();
            }
        } catch (error) {
            console.error('Error skipping break:', error);
            forceCloseModal('skip_error');
        }
    }

    function startTimer() {
        timeRemaining = 1200; // 20 minutes
        updateTimerDisplay();
        updateProgressRing();
        
        timerInterval = setInterval(() => {
            timeRemaining--;
            updateTimerDisplay();
            updateProgressRing();
            
            if (timeRemaining <= 0) {
                onTimerComplete();
            }
        }, 1000);
    }

    function stopTimer() {
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
    }

    function resetTimer() {
        stopTimer();
        timeRemaining = 1200; // Reset to 20 minutes
        startTimer();
    }

    function updateTimerDisplay() {
        const minutes = Math.floor(timeRemaining / 60);
        const seconds = timeRemaining % 60;
        const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        const timerDisplay = document.getElementById('timer-display');
        if (timerDisplay) {
            timerDisplay.textContent = display;
        }
    }

    function updateProgressRing() {
        const circle = document.getElementById('progress-circle');
        if (circle) {
            const totalTime = 1200; // 20 minutes
            const progress = ((totalTime - timeRemaining) / totalTime) * 691.15; // 2Ï€r where r=110
            circle.setAttribute('stroke-dasharray', `${progress} ${691.15 - progress}`);
        }
    }

    function onTimerComplete() {
        console.log('â° Timer completed! Starting break...');
        stopTimer();

        // Play notification sound (works even in background)
        playNotificationSound();

        // Show browser notification if enabled (works even when tab is inactive)
        if ('Notification' in window && Notification.permission === 'granted') {
            const notification = new Notification('â° 20-20-20 Break Time!', {
                body: 'Look at something 20 feet away for 20 seconds to rest your eyes.',
                icon: '/static/images/eye-icon.png',
                badge: '/static/images/eye-icon.png',
                tag: 'break-reminder', // Prevents duplicate notifications
                requireInteraction: true, // Keeps notification visible
                vibrate: [200, 100, 200], // Vibration pattern for mobile
                silent: false, // Allow sound
            });

            // When user clicks the notification, focus the tab
            notification.onclick = function(event) {
                event.preventDefault();
                window.focus();
                this.close();
            };
        }

        // Show break modal (only if tab is active)
        if (!document.hidden) {
            showBreakModal();
        } else {
            console.log('ðŸ“± Tab is inactive, notification sent. Modal will show when you return.');
            pendingBreakModal = true;
        }

        // Automatically take break
        takeBreak();
    }

    function showBreakModal() {
        try {
            // Clear any existing timeouts
            clearModalTimeouts();
            
            const modalElement = document.getElementById('breakModal');
            if (!modalElement) {
                console.error('Break modal element not found');
                handleModalError();
                return;
            }
            
            const modal = new bootstrap.Modal(modalElement, {
                backdrop: 'static',
                keyboard: true
            });
            
            // Add error handling for modal events
            modalElement.addEventListener('shown.bs.modal', onModalShown, { once: true });
            modalElement.addEventListener('hidden.bs.modal', onModalHidden, { once: true });
            
            modal.show();
            startBreakCountdown();
            
            // Set auto-close timeout (5 minutes maximum)
            modalAutoCloseTimeout = setTimeout(() => {
                console.warn('Modal auto-closing due to timeout');
                forceCloseModal('timeout');
            }, 300000); // 5 minutes
            
            // Track modal state
            isModalStuck = false;
            
        } catch (error) {
            console.error('Error showing break modal:', error);
            handleModalError();
        }
    }

    function hideBreakModal() {
        try {
            console.log('ðŸšª Hiding break modal...');
            clearModalTimeouts();

            const modalElement = document.getElementById('breakModal');
            if (!modalElement) {
                console.warn('âš ï¸ Modal element not found during hide');
                return;
            }

            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
                console.log('âœ… Using Bootstrap modal.hide()');
                modal.hide();

                // Force remove backdrop after hide (sometimes Bootstrap doesn't clean up)
                setTimeout(() => {
                    const backdrops = document.querySelectorAll('.modal-backdrop');
                    backdrops.forEach(backdrop => {
                        console.log('ðŸ§¹ Removing lingering backdrop');
                        backdrop.remove();
                    });
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                }, 300);
            } else {
                console.log('âš ï¸ No modal instance, using fallback');
                // Fallback: manually hide modal
                modalElement.style.display = 'none';
                modalElement.classList.remove('show');
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';

                // Remove all backdrops
                const backdrops = document.querySelectorAll('.modal-backdrop');
                backdrops.forEach(backdrop => backdrop.remove());
            }

            isModalStuck = false;
            console.log('âœ… Modal hidden successfully');
        } catch (error) {
            console.error('âŒ Error hiding break modal:', error);
            forceCloseModal('error');
        }
    }

    function startBreakCountdown() {
        let breakTime = 20;
        const countdownElement = document.getElementById('break-countdown');
        
        if (!countdownElement) {
            console.error('Break countdown element not found');
            return;
        }
        
        // Clear any existing break interval
        if (breakModalTimeout) {
            clearInterval(breakModalTimeout);
        }
        
        breakModalTimeout = setInterval(() => {
            breakTime--;
            if (countdownElement) {
                countdownElement.textContent = breakTime;
            }
            
            if (breakTime <= 0) {
                clearInterval(breakModalTimeout);
                breakModalTimeout = null;

                // Update countdown display
                if (countdownElement) {
                    countdownElement.textContent = 'âœ“';
                    countdownElement.classList.add('text-success');
                }

                // Update status message
                const statusElement = document.getElementById('countdown-status');
                if (statusElement) {
                    statusElement.innerHTML = '<strong class="text-success">Break complete! Click below to continue.</strong>';
                }

                // Highlight the complete break button
                const completeBtn = document.getElementById('complete-break-btn');
                if (completeBtn) {
                    completeBtn.classList.remove('btn-success');
                    completeBtn.classList.add('btn-primary', 'pulse-animation');
                    completeBtn.innerHTML = '<i class="fas fa-play me-2"></i>Continue to Next Interval';
                }

                // Auto-check the looked at distance checkbox
                const lookedCheckbox = document.getElementById('looked-distance');
                if (lookedCheckbox && !lookedCheckbox.checked) {
                    lookedCheckbox.checked = true;
                }

                // Show completion message
                console.log('âœ… Break countdown complete! Waiting for user to continue...');
            }
        }, 1000);
    }

    // Enhanced audio notification system
    function playNotificationSound() {
        try {
            // Get user's sound preferences (default to enabled if not set)
            const soundType = '{{ settings.notification_sound_type|default:"gentle" }}';
            const soundEnabled = {% if settings.sound_notification == False %}false{% else %}true{% endif %};
            const soundVolume = {{ settings.sound_volume|default:0.7 }};

            console.log('ðŸ”Š Playing notification sound:', {soundType, soundEnabled, soundVolume});

            if (!soundEnabled) {
                console.log('ðŸ”‡ Sound notifications disabled by user');
                return;
            }

            // Play sound based on user preference
            playBreakReminderSound(soundType, soundVolume);

        } catch (error) {
            console.error('âŒ Error playing notification sound:', error);
            // Fallback to basic beep
            try {
                playBasicBeep();
            } catch (e) {
                console.error('âŒ Fallback beep also failed:', e);
            }
        }
    }
    
    function playBreakReminderSound(soundType = 'gentle', volume = 0.5) {
        const soundOptions = {
            'gentle': {
                frequency: 800,
                duration: 500,
                pattern: [1, 0.5, 1] // On, pause, on
            },
            'chime': {
                frequency: [523, 659, 784], // C, E, G chord
                duration: 300,
                pattern: [1, 1, 1]
            },
            'beep': {
                frequency: 1000,
                duration: 200,
                pattern: [1, 0.3, 1, 0.3, 1]
            },
            'bell': {
                frequency: [440, 554, 659], // A, C#, E
                duration: 800,
                pattern: [1]
            }
        };
        
        const sound = soundOptions[soundType] || soundOptions['gentle'];
        
        // Use Web Audio API for better control
        if (window.AudioContext || window.webkitAudioContext) {
            playWebAudioSound(sound, volume);
        } else {
            // Fallback for older browsers
            playBasicBeep(volume);
        }
    }
    
    function playWebAudioSound(soundConfig, volume = 0.5) {
        try {
            console.log('ðŸŽµ Creating audio context...');
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const { frequency, duration, pattern } = soundConfig;

            console.log('ðŸŽµ Playing sound with config:', {frequency, duration, pattern, volume});

            let currentTime = audioContext.currentTime;
            
            pattern.forEach((amplitude, index) => {
                if (amplitude > 0) {
                    // Create oscillator for each tone
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    // Set frequency (single or array for chords)
                    if (Array.isArray(frequency)) {
                        const freq = frequency[index % frequency.length];
                        oscillator.frequency.setValueAtTime(freq, currentTime);
                    } else {
                        oscillator.frequency.setValueAtTime(frequency, currentTime);
                    }
                    
                    // Configure gain envelope for smooth sound with user volume
                    gainNode.gain.setValueAtTime(0, currentTime);
                    gainNode.gain.linearRampToValueAtTime(volume * 0.3 * amplitude, currentTime + 0.01);
                    gainNode.gain.linearRampToValueAtTime(volume * 0.1 * amplitude, currentTime + duration/1000 - 0.01);
                    gainNode.gain.linearRampToValueAtTime(0, currentTime + duration/1000);
                    
                    // Connect audio nodes
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    // Start and stop oscillator
                    oscillator.start(currentTime);
                    oscillator.stop(currentTime + duration/1000);
                }
                
                currentTime += duration/1000 + 0.1; // Add small gap between tones
            });
            
            // Show visual feedback
            showSoundNotification('ðŸ”” Break time! Look at something 20 feet away');
            
        } catch (error) {
            console.error('Web Audio API error:', error);
            
            // Browser-specific error handling
            const userAgent = navigator.userAgent;
            if (userAgent.includes('Safari') && !userAgent.includes('Chrome')) {
                console.log('Safari detected, using fallback audio method');
            } else if (userAgent.includes('Firefox')) {
                console.log('Firefox detected, using HTML5 audio fallback');
            } else if (userAgent.includes('Mobile') || userAgent.includes('Android') || userAgent.includes('iPhone')) {
                console.log('Mobile device detected, using simplified audio');
                // Try vibration as additional feedback on mobile
                if ('vibrate' in navigator) {
                    navigator.vibrate([200, 100, 200]);
                }
            }
            
            playBasicBeep(volume);
        }
    }
    
    function playBasicBeep(volume = 0.5) {
        try {
            // Fallback using HTML5 Audio with generated tone
            const beepSound = 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwjBC2OzPLZhzsCFmm98OKicxoNTqXo9KR1FAxNn+Dvwn0pBS19yO7djjoJHmS58OycQQsUYLXr66ZRFQ9Mn+DwxXwpBS5+yO7djjoJHWS58OycQQsUYLXr66ZRFQ==';
            
            const audio = new Audio(beepSound);
            audio.volume = Math.max(0.1, Math.min(1.0, volume)); // Clamp volume between 0.1 and 1.0
            
            const playPromise = audio.play();
            if (playPromise !== undefined) {
                playPromise
                    .then(() => {
                        console.log('Break reminder sound played successfully');
                        showSoundNotification('ðŸ”” Break time!');
                    })
                    .catch(error => {
                        console.log('Could not play notification sound:', error.message);
                        // Show visual notification instead
                        showSoundNotification('ðŸ”” BREAK TIME! Look 20 feet away', 'warning');
                    });
            }
            
        } catch (error) {
            console.error('Basic beep error:', error);
            showSoundNotification('ðŸ”” BREAK TIME! Look 20 feet away', 'warning');
        }
    }
    
    function showSoundNotification(message, type = 'info') {
        // Create visual notification when sound plays
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} sound-notification`;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10001;
            padding: 15px 25px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 18px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            animation: soundPulse 2s ease-in-out;
        `;
        notification.innerHTML = message;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'fadeOut 0.5s ease-out forwards';
            setTimeout(() => notification.remove(), 500);
        }, 3000);
    }
    
    // Test sound function for user preference
    function testNotificationSound(soundType = 'gentle', volume = 0.5) {
        console.log('Testing sound:', soundType, 'at volume:', volume);
        playBreakReminderSound(soundType, volume);
    }
    
    // Request audio permission on first interaction
    function requestAudioPermission() {
        if (window.AudioContext || window.webkitAudioContext) {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
            } catch (error) {
                console.log('Audio context initialization failed:', error);
            }
        }
    }
    
    // Modal management helper functions
    function clearModalTimeouts() {
        if (breakModalTimeout) {
            clearInterval(breakModalTimeout);
            breakModalTimeout = null;
        }
        if (modalAutoCloseTimeout) {
            clearTimeout(modalAutoCloseTimeout);
            modalAutoCloseTimeout = null;
        }
    }
    
    function forceCloseModal(reason = 'unknown') {
        console.log('Force closing modal due to:', reason);
        try {
            clearModalTimeouts();
            
            const modalElement = document.getElementById('breakModal');
            if (modalElement) {
                // Force hide modal
                modalElement.style.display = 'none';
                modalElement.classList.remove('show');
                modalElement.setAttribute('aria-hidden', 'true');
            }
            
            // Remove body classes and backdrop
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
            
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => backdrop.remove());
            
            // Reset modal state
            isModalStuck = false;
            
            // Show user notification
            showNotification('Break reminder closed. Timer will resume automatically.', 'info');
            
            // Resume timer if session is active
            if (currentSession && !timerInterval) {
                resetTimer();
            }
            
        } catch (error) {
            console.error('Error force closing modal:', error);
            // Last resort: refresh page
            showNotification('Refreshing page to resolve modal issue...', 'warning');
            setTimeout(() => location.reload(), 2000);
        }
    }
    
    function handleModalError() {
        console.error('Modal error detected, attempting recovery');
        isModalStuck = true;
        
        // Try to complete break automatically
        if (currentBreak) {
            completeBreak();
        } else {
            forceCloseModal('error_recovery');
        }
    }
    
    function onModalShown() {
        console.log('Break modal shown successfully');
        // Set focus trap for accessibility
        const modal = document.getElementById('breakModal');
        const firstFocusable = modal.querySelector('button, input');
        if (firstFocusable) {
            firstFocusable.focus();
        }
    }
    
    function onModalHidden() {
        console.log('Break modal hidden successfully');
        clearModalTimeouts();
        isModalStuck = false;
    }
    
    // Emergency escape mechanism
    function addEmergencyEscape() {
        let escapeKeyCount = 0;
        let escapeKeyTimer = null;
        
        document.addEventListener('keydown', function(e) {
            // Double ESC to force close stuck modal
            if (e.key === 'Escape') {
                escapeKeyCount++;
                
                if (escapeKeyTimer) {
                    clearTimeout(escapeKeyTimer);
                }
                
                if (escapeKeyCount >= 2) {
                    const modal = document.getElementById('breakModal');
                    if (modal && modal.classList.contains('show')) {
                        forceCloseModal('double_escape');
                    }
                    escapeKeyCount = 0;
                } else {
                    escapeKeyTimer = setTimeout(() => {
                        escapeKeyCount = 0;
                    }, 1000);
                }
            }
            
            // Ctrl+Alt+R to force refresh if everything is stuck
            if (e.ctrlKey && e.altKey && e.key === 'r') {
                if (isModalStuck) {
                    showNotification('Emergency refresh triggered', 'warning');
                    setTimeout(() => location.reload(), 1000);
                }
            }
        });
    }

    function showNotification(message, type = 'info') {
        try {
            const alertClass = `alert-${type}`;
            const notification = document.createElement('div');
            notification.className = `alert ${alertClass} alert-dismissible fade show notification`;
            notification.style.zIndex = '10000'; // Ensure it appears above modals
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        } catch (error) {
            console.error('Error showing notification:', error);
            // Fallback to console log
            console.log('Notification:', message);
        }
    }

    // Request notification permissions for background alerts
    function requestNotificationPermission() {
        if ('Notification' in window) {
            if (Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        console.log('âœ… Notification permission granted');
                        showNotification('Notifications enabled! You\'ll receive break reminders even when on other tabs.', 'success');
                    } else {
                        console.log('âš ï¸ Notification permission denied');
                    }
                });
            } else if (Notification.permission === 'granted') {
                console.log('âœ… Notification permission already granted');
            }
        } else {
            console.warn('âš ï¸ This browser does not support notifications');
        }
    }

    // Clean up any lingering modal backdrops from previous sessions
    function cleanupModalBackdrops() {
        const backdrops = document.querySelectorAll('.modal-backdrop');
        if (backdrops.length > 0) {
            console.log('ðŸ§¹ Cleaning up', backdrops.length, 'lingering modal backdrop(s)');
            backdrops.forEach(backdrop => backdrop.remove());
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
        }
    }

    // Initialize escape mechanisms and audio
    cleanupModalBackdrops();
    addEmergencyEscape();
    initializeAudioSystem();

    // Request notification permission if timer is active
    {% if active_session %}
        requestNotificationPermission();
    {% endif %}

    // Handle page visibility changes - show modal when user returns to tab
    let pendingBreakModal = false;

    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
            console.log('ðŸ‘ï¸ Tab became visible');

            // If there's a pending break modal, show it now
            if (pendingBreakModal) {
                console.log('ðŸ“± Showing pending break modal');
                showBreakModal();
                pendingBreakModal = false;
            }

            // Sync timer state when returning to tab
            if (currentSession) {
                syncTimerState();
            }
        } else {
            console.log('ðŸ‘ï¸â€ðŸ—¨ï¸ Tab hidden');
        }
    });

    // Mark that we need to show modal when tab becomes visible
    window.setPendingBreakModal = function() {
        pendingBreakModal = true;
    };
    
    // Display session start time in user's browser timezone
    {% if active_session %}
        // Update session start time display with browser's local time
        const sessionStartTimeElement = document.getElementById('session-start-time');
        if (sessionStartTimeElement) {
            const startTime = new Date('{{ active_session.start_time|date:"c" }}');
            const localTimeString = startTime.toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
            // Show browser timezone if different from user's set timezone
            const browserTZ = Intl.DateTimeFormat().resolvedOptions().timeZone;
            const userTZ = '{{ user.timezone }}';
            if (browserTZ !== userTZ) {
                sessionStartTimeElement.innerHTML = `${localTimeString} <small class="text-muted">(${browserTZ})</small>`;
            } else {
                sessionStartTimeElement.textContent = localTimeString;
            }
        }
    {% endif %}

    // Initialize timer if there's an active session (with better error handling)
    {% if active_session %}
        try {
            // Calculate remaining time based on current interval
            // Use ISO format which includes timezone info
            const sessionStartTime = new Date('{{ active_session.start_time|date:"c" }}');
            const now = new Date();
            const elapsedMinutes = Math.floor((now - sessionStartTime) / 60000);
            const intervalsCompleted = {{ active_session.total_intervals_completed }};
            const currentIntervalElapsed = elapsedMinutes - (intervalsCompleted * 20);
            
            console.log('Initializing active session:', {
                elapsedMinutes,
                intervalsCompleted,
                currentIntervalElapsed
            });
            
            if (currentIntervalElapsed < 20 && currentIntervalElapsed >= 0) {
                timeRemaining = (20 - currentIntervalElapsed) * 60;
                if (timeRemaining > 0) {
                    startTimer();
                } else {
                    // Timer should have completed, but add safety check
                    console.log('Timer should have completed, checking server state');
                    syncTimerState();
                }
            } else if (currentIntervalElapsed >= 20) {
                // Timer should have completed, but verify with server first
                console.log('Timer appears completed, syncing with server');
                syncTimerState();
            } else {
                // Negative elapsed time, something's wrong
                console.warn('Negative elapsed time detected, syncing with server');
                syncTimerState();
            }
        } catch (error) {
            console.error('Error initializing timer:', error);
            showNotification('Timer initialization error. Please refresh the page.', 'warning');
        }
    {% endif %}
    
    // Handle page visibility change to maintain timer state (improved)
    document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'visible') {
            console.log('Page became visible, checking session state');
            
            // Check if modal is stuck
            const modal = document.getElementById('breakModal');
            if (modal && modal.classList.contains('show') && !currentBreak) {
                console.warn('Found stuck modal without active break');
                forceCloseModal('visibility_check');
            }
            
            // Sync timer state if we have an active session
            if (currentSession) {
                // Small delay to ensure page is fully active
                setTimeout(() => {
                    syncTimerState();
                }, 500);
            }
        } else {
            console.log('Page hidden, timer will continue in background');
        }
    });
    
    // Sync timer state with server (improved with error handling)
    function syncTimerState() {
        if (!currentSession) {
            console.log('No active session to sync');
            return;
        }

        const csrfToken = getCSRFToken();

        // Add timeout to prevent hanging requests
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout

        fetch('{% url "timer:sync_session" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                session_id: currentSession
            }),
            signal: controller.signal
        })
        .then(response => {
            clearTimeout(timeoutId);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            return response.json();
        })
        .then(data => {
            if (data.success) {
                handleSuccessfulSync(data);
            } else {
                handleSyncError('Server returned error: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            clearTimeout(timeoutId);
            if (error.name === 'AbortError') {
                console.warn('Timer sync request timed out');
                handleSyncTimeout();
            } else {
                console.error('Error syncing timer state:', error);
                handleSyncError(error.message);
            }
        });
    }
    
    function handleSuccessfulSync(data) {
        try {
            if (data.session_active) {
                // Update current interval
                currentInterval = data.interval_id;
                
                // Recalculate timer based on server state
                const elapsedSeconds = data.interval_elapsed_seconds;
                const intervalDurationSeconds = data.interval_duration_minutes * 60;
                
                if (elapsedSeconds < intervalDurationSeconds) {
                    const newTimeRemaining = intervalDurationSeconds - elapsedSeconds;
                    
                    // Only update if there's a significant difference (more than 5 seconds)
                    if (Math.abs(timeRemaining - newTimeRemaining) > 5) {
                        timeRemaining = newTimeRemaining;
                        updateTimerDisplay();
                        updateProgressRing();
                    }
                    
                    if (!timerInterval) {
                        startTimer();
                    }
                } else {
                    // Timer should have completed
                    console.log('Timer completed while away, showing break modal');
                    onTimerComplete();
                }
            } else {
                // Session ended on server side
                console.log('Session ended on server, cleaning up');
                stopTimer();
                currentSession = null;
                currentInterval = null;
                showNotification('Your session has ended', 'info');
                
                // Delayed reload to allow user to see notification
                setTimeout(() => location.reload(), 2000);
            }
        } catch (error) {
            console.error('Error handling sync response:', error);
            handleSyncError('Failed to process sync response');
        }
    }
    
    function handleSyncError(errorMessage) {
        console.warn('Timer sync failed:', errorMessage);
        
        // Don't show error to user for minor sync issues
        // Just continue with client-side timer
        if (!timerInterval && currentSession) {
            console.log('Restarting timer due to sync failure');
            startTimer();
        }
    }
    
    function handleSyncTimeout() {
        console.warn('Timer sync timed out, continuing with local timer');
        // Continue with local timer state
        if (!timerInterval && currentSession) {
            startTimer();
        }
    }
    
    // Real-time updates for personal statistics only
    function updateDashboardStats() {
        fetch('{% url "analytics:dashboard_metrics_api" %}')
            .then(response => response.json())
            .then(data => {
                // Update today's personal stats dynamically
                const todayStats = data.today;
                
                // Find and update stat cards by their structure
                const statCards = document.querySelectorAll('.card-body h3');
                statCards.forEach(element => {
                    const parentCard = element.closest('.card-body');
                    const label = parentCard.querySelector('p');
                    
                    if (label && label.textContent.includes('Minutes Worked')) {
                        element.textContent = todayStats.work_minutes;
                    } else if (label && label.textContent.includes('Intervals Completed')) {
                        element.textContent = todayStats.intervals_completed;
                    } else if (label && label.textContent.includes('Breaks Taken')) {
                        element.textContent = todayStats.breaks_taken;
                    } else if (label && label.textContent.includes('Compliance Rate')) {
                        element.textContent = todayStats.compliance_rate.toFixed(0) + '%';
                    }
                });
            })
            .catch(error => console.error('Error updating dashboard stats:', error));
    }
    
    // Track activity when user interacts
    function trackDashboardActivity(eventType, eventData = {}) {
        const csrfToken = getCSRFToken();

        fetch('{% url "analytics:track_activity" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                event_type: eventType,
                event_data: eventData
            })
        }).catch(error => {
            console.error('Error tracking activity:', error);
        });
    }
    
    // Update stats every 30 seconds and track page view
    setInterval(updateDashboardStats, 30000);
    trackDashboardActivity('feature_used', { feature: 'dashboard' });
    
    // Test function for modal fixes (development/debug)
    window.testModalFixes = function() {
        console.log('ðŸ”§ Testing modal fixes...');
        
        const tests = [
            {
                name: 'Emergency escape mechanism',
                test: () => typeof addEmergencyEscape === 'function' ? 'Available' : 'Missing'
            },
            {
                name: 'Force close function',
                test: () => typeof forceCloseModal === 'function' ? 'Available' : 'Missing'
            },
            {
                name: 'Modal timeout variables',
                test: () => (modalAutoCloseTimeout !== undefined && breakModalTimeout !== undefined) ? 'Available' : 'Missing'
            },
            {
                name: 'Error handling functions',
                test: () => (typeof handleSyncError === 'function' && typeof handleModalError === 'function') ? 'Available' : 'Missing'
            }
        ];
        
        tests.forEach(test => {
            try {
                const result = test.test();
                console.log(`${result === 'Available' ? 'âœ…' : 'âŒ'} ${test.name}: ${result}`);
            } catch (error) {
                console.log(`âŒ ${test.name}: Error - ${error.message}`);
            }
        });
        
        return 'Modal fix tests completed - check console for results';
    };
    
    // Add audio test functions to window
    window.testBreakSound = function(type = 'gentle') {
        const volume = {{ settings.sound_volume|default:0.5 }};
        testNotificationSound(type, volume);
        return 'Testing sound: ' + type + ' at volume: ' + (volume * 100) + '%';
    };
    window.checkAudioSupport = checkAudioSupport;
    
    // Log that fixes are loaded
    console.log('âœ… Timer modal fixes loaded successfully');
    console.log('ðŸ’¡ Use window.testModalFixes() to test emergency mechanisms');
    console.log('ðŸ”Š Use window.testBreakSound("gentle"|"chime"|"beep"|"bell") to test sounds');
    console.log('ðŸ”§ Emergency shortcuts: Double ESC to force close modal, Ctrl+Alt+R to refresh if stuck');

    // Add event listeners for buttons (CSP compliant - no inline onclick)
    function attachEventListeners() {
        console.log('ðŸ”§ Attaching event listeners...');

        // Start session button
        const startBtn = document.getElementById('start-session-btn');
        if (startBtn) {
            startBtn.addEventListener('click', startSession);
            console.log('âœ… Start session button listener attached');
        } else {
            console.warn('âš ï¸ Start session button not found');
        }

        // End session button
        const endBtn = document.getElementById('end-session-btn');
        if (endBtn) {
            endBtn.addEventListener('click', endSession);
            console.log('âœ… End session button listener attached');
        } else {
            console.log('â„¹ï¸ End session button not found (no active session)');
        }

        // Take break button
        const breakBtn = document.getElementById('take-break-btn');
        if (breakBtn) {
            breakBtn.addEventListener('click', takeBreak);
            console.log('âœ… Take break button listener attached');
        } else {
            console.log('â„¹ï¸ Take break button not found (no active session)');
        }

        // Modal buttons
        const skipBreakBtn = document.getElementById('skip-break-btn');
        if (skipBreakBtn) {
            skipBreakBtn.addEventListener('click', skipBreak);
            console.log('âœ… Skip break button listener attached');
        }

        const completeBreakBtn = document.getElementById('complete-break-btn');
        if (completeBreakBtn) {
            completeBreakBtn.addEventListener('click', completeBreak);
            console.log('âœ… Complete break button listener attached');
        }

        const forceCloseBtn = document.getElementById('force-close-modal-btn');
        if (forceCloseBtn) {
            forceCloseBtn.addEventListener('click', function() {
                forceCloseModal('user_initiated');
            });
            console.log('âœ… Force close button listener attached');
        }
    }

    // Try both DOMContentLoaded and immediate execution
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', attachEventListeners);
    } else {
        // DOM already loaded
        attachEventListeners();
    }
    
    // Audio system initialization and browser compatibility
    function initializeAudioSystem() {
        // Check audio support on page load
        const support = checkAudioSupport();
        
        if (!support.webAudio && !support.htmlAudio) {
            console.warn('No audio support detected');
            showNotification('Audio notifications not supported in this browser', 'warning');
        } else if (!support.webAudio) {
            console.info('Using HTML5 Audio fallback (limited sound options)');
        }
        
        // Request audio permission early (Chrome requires user gesture)
        document.addEventListener('click', requestAudioPermission, { once: true });
        document.addEventListener('touchstart', requestAudioPermission, { once: true });
    }
    
    function checkAudioSupport() {
        const support = {
            webAudio: !!(window.AudioContext || window.webkitAudioContext),
            htmlAudio: !!window.Audio,
            notifications: 'Notification' in window,
            vibration: 'vibrate' in navigator,
            userAgent: navigator.userAgent
        };
        
        // Browser-specific checks
        support.browser = {
            chrome: /Chrome/.test(navigator.userAgent),
            firefox: /Firefox/.test(navigator.userAgent),
            safari: /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent),
            edge: /Edg/.test(navigator.userAgent),
            mobile: /Mobile|Android|iPhone|iPad/.test(navigator.userAgent)
        };
        
        console.log('ðŸ”Š Audio support check:', support);
        return support;
    }
</script>
{% endblock %}