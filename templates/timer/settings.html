{% extends 'base.html' %}
{% load timezone_tags %}

{% block title %}Timer Settings - EyeHealth 20-20-20{% endblock %}

{% block extra_css %}
<style>
    .settings-card {
        transition: transform 0.2s ease-in-out;
    }
    
    .settings-card:hover {
        transform: translateY(-2px);
    }
    
    .form-check-input:checked {
        background-color: #007bff;
        border-color: #007bff;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h2 mb-1">
                        <i class="fas fa-cog me-2"></i>Timer Settings
                    </h1>
                    <p class="text-muted mb-0">Customize your 20-20-20 timer experience</p>
                </div>
                <a href="{% url 'timer:dashboard' %}" class="btn btn-outline-primary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                </a>
            </div>
        </div>
    </div>

    <form method="post">
        {% csrf_token %}
        
        <!-- Basic Timer Settings -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card settings-card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-clock me-2"></i>Timer Intervals
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="work_interval_minutes" class="form-label">Work Interval (minutes)</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="work_interval_minutes" 
                                           name="work_interval_minutes" value="{{ settings.work_interval_minutes }}" 
                                           min="5" max="60">
                                    <span class="input-group-text">min</span>
                                </div>
                                <div class="form-text">Standard is 20 minutes</div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="break_duration_seconds" class="form-label">Break Duration (seconds)</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="break_duration_seconds" 
                                           name="break_duration_seconds" value="{{ settings.break_duration_seconds }}" 
                                           min="10" max="300">
                                    <span class="input-group-text">sec</span>
                                </div>
                                <div class="form-text">Standard is 20 seconds</div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="long_break_minutes" class="form-label">Long Break (minutes)</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="long_break_minutes" 
                                           name="long_break_minutes" value="{{ settings.long_break_minutes }}" 
                                           min="1" max="30" disabled>
                                    <span class="input-group-text">min</span>
                                </div>
                                <div class="form-text">Every 4 intervals</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notification Settings -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card settings-card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-bell me-2"></i>Notifications
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="sound_notification" 
                                           name="sound_notification" {% if settings.sound_notification %}checked{% endif %}>
                                    <label class="form-check-label" for="sound_notification">
                                        <i class="fas fa-volume-up me-2"></i>Sound Notifications
                                    </label>
                                </div>
                                <div class="form-text">Play sound when break time arrives</div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="desktop_notification" 
                                           name="desktop_notification" {% if settings.desktop_notification %}checked{% endif %}>
                                    <label class="form-check-label" for="desktop_notification">
                                        <i class="fas fa-desktop me-2"></i>Desktop Notifications
                                    </label>
                                </div>
                                <div class="form-text">Show browser notifications</div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="email_notification"
                                           name="email_notification" {% if settings.email_notification %}checked{% endif %}>
                                    <label class="form-check-label" for="email_notification">
                                        <i class="fas fa-envelope me-2"></i>Email Summaries
                                    </label>
                                </div>
                                <div class="form-text">Daily/weekly email reports</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sound Settings -->
        <div class="row mb-4" id="sound-settings" style="display: {{ settings.sound_notification|yesno:'block,none' }};">
            <div class="col-12">
                <div class="card settings-card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-volume-up me-2"></i>Sound Options
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="notification_sound_type" class="form-label">Sound Type</label>
                                <select class="form-select" id="notification_sound_type" name="notification_sound_type">
                                    <option value="gentle" {% if settings.notification_sound_type == 'gentle' %}selected{% endif %}>ðŸ”” Gentle Tone</option>
                                    <option value="chime" {% if settings.notification_sound_type == 'chime' %}selected{% endif %}>ðŸŽµ Chime</option>
                                    <option value="beep" {% if settings.notification_sound_type == 'beep' %}selected{% endif %}>ðŸ“¢ Beep</option>
                                    <option value="bell" {% if settings.notification_sound_type == 'bell' %}selected{% endif %}>ðŸ”” Bell</option>
                                </select>
                                <div class="form-text">Choose the sound that plays when timer reaches zero</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="sound_volume" class="form-label">Volume</label>
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-volume-down me-2"></i>
                                    <input type="range" class="form-range flex-grow-1 mx-2" id="sound_volume" 
                                           name="sound_volume" min="0" max="1" step="0.1" 
                                           value="{{ settings.sound_volume|default:0.5 }}">
                                    <i class="fas fa-volume-up ms-2"></i>
                                </div>
                                <div class="form-text" id="volume-display">Volume: {{ settings.sound_volume|default:0.5|floatformat:0|mul:100 }}% - Adjust notification sound volume</div>
                                <div class="mt-2">
                                    <button type="button" class="btn btn-outline-primary btn-sm" id="test-sound-btn">
                                        <i class="fas fa-play me-1"></i>Test Sound
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Display Settings -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card settings-card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-eye me-2"></i>Display Options
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="show_progress_bar" 
                                           name="show_progress_bar" {% if settings.show_progress_bar %}checked{% endif %}>
                                    <label class="form-check-label" for="show_progress_bar">
                                        <i class="fas fa-chart-line me-2"></i>Progress Ring
                                    </label>
                                </div>
                                <div class="form-text">Show circular progress indicator</div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="show_time_remaining" 
                                           name="show_time_remaining" {% if settings.show_time_remaining %}checked{% endif %}>
                                    <label class="form-check-label" for="show_time_remaining">
                                        <i class="fas fa-clock me-2"></i>Time Remaining
                                    </label>
                                </div>
                                <div class="form-text">Display countdown timer</div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="dark_mode" 
                                           name="dark_mode" {% if settings.dark_mode %}checked{% endif %}>
                                    <label class="form-check-label" for="dark_mode">
                                        <i class="fas fa-moon me-2"></i>Dark Mode
                                    </label>
                                </div>
                                <div class="form-text">Use dark theme</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Advanced Settings -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card settings-card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-cog me-2"></i>Advanced Features
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="auto_start_break"
                                           name="auto_start_break" {% if settings.auto_start_break %}checked{% endif %}>
                                    <label class="form-check-label" for="auto_start_break">
                                        <i class="fas fa-play-circle me-2"></i>Auto-Start Breaks
                                    </label>
                                </div>
                                <div class="form-text">Automatically start break countdown</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="auto_start_work"
                                           name="auto_start_work" {% if settings.auto_start_work %}checked{% endif %}>
                                    <label class="form-check-label" for="auto_start_work">
                                        <i class="fas fa-forward me-2"></i>Auto-Resume Work
                                    </label>
                                </div>
                                <div class="form-text">Automatically resume timer after breaks</div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12 mb-3">
                                <label for="custom_break_messages" class="form-label">
                                    <i class="fas fa-comment-alt me-2"></i>Custom Break Messages
                                </label>
                                <textarea class="form-control" id="custom_break_messages" name="custom_break_messages"
                                          rows="3" placeholder="Enter custom motivational messages for breaks, one per line">{{ settings.custom_break_messages }}</textarea>
                                <div class="form-text">Personalized messages to display during breaks</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Save Button -->
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-end">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-save me-2"></i>Save Settings
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script nonce="{{ request.csp_nonce }}">
    // Request notification permission if desktop notifications are enabled
    document.getElementById('desktop_notification').addEventListener('change', function() {
        if (this.checked && 'Notification' in window) {
            if (Notification.permission === 'default') {
                Notification.requestPermission().then(function(permission) {
                    if (permission !== 'granted') {
                        // Uncheck if permission denied
                        document.getElementById('desktop_notification').checked = false;
                        alert('Please allow notifications in your browser settings to enable this feature.');
                    }
                });
            }
        }
    });
    
    // Show/hide sound settings based on sound notification toggle
    document.getElementById('sound_notification').addEventListener('change', function() {
        const soundSettings = document.getElementById('sound-settings');
        soundSettings.style.display = this.checked ? 'block' : 'none';
    });
    
    // Test sound function
    function testSound() {
        const soundType = document.getElementById('notification_sound_type').value;
        const volume = parseFloat(document.getElementById('sound_volume').value);
        
        // Create a temporary audio context to test sound
        if (window.AudioContext || window.webkitAudioContext) {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                const soundConfig = {
                    'gentle': { frequency: 800, duration: 500, pattern: [1, 0.5, 1] },
                    'chime': { frequency: [523, 659, 784], duration: 300, pattern: [1, 1, 1] },
                    'beep': { frequency: 1000, duration: 200, pattern: [1, 0.3, 1, 0.3, 1] },
                    'bell': { frequency: [440, 554, 659], duration: 800, pattern: [1] }
                };
                
                const sound = soundConfig[soundType] || soundConfig['gentle'];
                const { frequency, duration, pattern } = sound;
                
                let currentTime = audioContext.currentTime;
                
                pattern.forEach((amplitude, index) => {
                    if (amplitude > 0) {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        if (Array.isArray(frequency)) {
                            const freq = frequency[index % frequency.length];
                            oscillator.frequency.setValueAtTime(freq, currentTime);
                        } else {
                            oscillator.frequency.setValueAtTime(frequency, currentTime);
                        }
                        
                        gainNode.gain.setValueAtTime(0, currentTime);
                        gainNode.gain.linearRampToValueAtTime(volume * amplitude * 0.3, currentTime + 0.01);
                        gainNode.gain.linearRampToValueAtTime(volume * amplitude * 0.1, currentTime + duration/1000 - 0.01);
                        gainNode.gain.linearRampToValueAtTime(0, currentTime + duration/1000);
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        oscillator.start(currentTime);
                        oscillator.stop(currentTime + duration/1000);
                    }
                    
                    currentTime += duration/1000 + 0.1;
                });
                
                // Visual feedback
                const testBtn = document.getElementById('test-sound-btn');
                if (testBtn) {
                    const originalText = testBtn.innerHTML;
                    testBtn.innerHTML = '<i class="fas fa-volume-up me-1"></i>Playing...';
                    testBtn.disabled = true;

                    setTimeout(() => {
                        testBtn.innerHTML = originalText;
                        testBtn.disabled = false;
                    }, 2000);
                }
                
            } catch (error) {
                console.error('Test sound error:', error);
                alert('Could not play test sound. Please check your browser\'s audio settings.');
            }
        } else {
            alert('Audio testing not supported in this browser.');
        }
    }
    
    // Update volume display
    document.getElementById('sound_volume').addEventListener('input', function() {
        const volumePercent = Math.round(this.value * 100);
        const volumeDisplay = document.getElementById('volume-display');
        if (volumeDisplay) {
            volumeDisplay.textContent = `Volume: ${volumePercent}% - Adjust notification sound volume`;
        }
    });

    // Dark mode toggle immediate effect
    document.getElementById('dark_mode').addEventListener('change', function() {
        if (this.checked) {
            document.body.classList.add('dark-theme');
            localStorage.setItem('darkTheme', 'true');
        } else {
            document.body.classList.remove('dark-theme');
            localStorage.setItem('darkTheme', 'false');
        }
    });
    
    // Initialize volume display
    const volumeSlider = document.getElementById('sound_volume');
    if (volumeSlider) {
        const volumePercent = Math.round(volumeSlider.value * 100);
        const volumeDisplay = document.getElementById('volume-display');
        if (volumeDisplay) {
            volumeDisplay.textContent = `Volume: ${volumePercent}% - Adjust notification sound volume`;
        }
    }

    // Add event listener for test sound button
    document.addEventListener('DOMContentLoaded', function() {
        const testSoundBtn = document.getElementById('test-sound-btn');
        if (testSoundBtn) {
            testSoundBtn.addEventListener('click', testSound);
        }
    });

    // Show success message if form was submitted
    {% if messages %}
        {% for message in messages %}
            {% if message.tags == 'success' %}
                // Show success notification
                const notification = document.createElement('div');
                notification.className = 'alert alert-success alert-dismissible fade show position-fixed';
                notification.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
                notification.innerHTML = `
                    <i class="fas fa-check-circle me-2"></i>{{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.remove();
                }, 5000);
            {% endif %}
        {% endfor %}
    {% endif %}
</script>
{% endblock %}